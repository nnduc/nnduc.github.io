<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> @objc Warnings Upgrading To Swift 4 · Duc Ninja</title><meta name="description" content="@objc Warnings Upgrading To Swift 4 - Duc Ninja"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://duc.ninja/atom.xml" title="Duc Ninja"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://twitter.com/duccuimia" target="_blank" class="nav-list-link">TWITTER</a></li><li class="nav-list-item"><a href="https://github.com/ducito" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">@objc Warnings Upgrading To Swift 4</h1><div class="post-info">Nov 4, 2017</div><div class="post-content"><p>Open a Swift 3 project in Xcode 9 and it will warn you that you can upgrade to Swift 4. If you accept the invite you end up with another warning that Swift 4 mode deprecates the Swift 3 <code>@objc</code> inference rules. What is this scary sounding warning and how do you make it go away?</p>
<h3 id="What-Is-objc-Inference"><a href="#What-Is-objc-Inference" class="headerlink" title="What Is @objc Inference?"></a>What Is @objc Inference?</h3><p>I’ll confess that <code>@objc</code> inference was not something I spent a lot of time thinking about before Swift 4 changed the rules. You can add <code>@objc</code> to Swift properties or methods to make them accessibile from Objective-C code. To make life easier the compiler also has some rules for when it will infer the <code>@objc</code> for you.</p>
<p>The Swift 3 compiler is generous about adding <code>@objc</code> even when you may not need it. This convenience comes at a cost of larger binaries as each of those methods gets some extra code to map between the Swift and Objective-C calling conventions.</p>
<p>The Swift 4 compiler takes a more conservative approach and only infers <code>@objc</code> in limited cases. For example, when overriding an <code>@objc</code> method or implementing an <code>@objc</code> protocol. So you don’t need to worry about marking all your <code>UITableViewDataSource</code> methods with <code>@objc</code>. You also don’t need to add <code>@objc</code> with <code>@IBAction</code>, <code>@IBOutlet</code>, <code>@IBInspectable</code> or <code>@NSManaged</code>.</p>
<p>This makes the rules simpler to understand but means you have some work to do when upgrading to Swift 4.</p>
<h3 id="Upgrading-To-Swift-4"><a href="#Upgrading-To-Swift-4" class="headerlink" title="Upgrading To Swift 4"></a>Upgrading To Swift 4</h3><p>When you open a Swift 3 project in Xcode 9 it greets you with a build warning - “Conversion to Swift 4 is available”:</p>
<p><img src="/assets/images/2017-10-26-001.png" alt=""></p>
<p>It is annoying to have a build warning but you are not forced to upgrade to Swift 4. Xcode 9 supports both Swift 3.2 and Swift 4 through a build setting so you can migrate one target at a time.</p>
<p><img src="/assets/images/2017-10-27-001.png" alt=""><br>Assuming you want to upgrade to Swift 4, clicking the build warning starts the Xcode migrator so you can choose which targets to upgrade. You have two choices for the migration:<br><img src="/assets/images/2017-10-26-002.png" alt=""></p>
<ul>
<li>Minimize Inference: This is the recommended approach. The migrator will only add <code>@objc</code> to your code in the obvious places such as methods that are the target for a <code>#selector</code>. This should give you a smaller binary but you have some extra manual work to do to finish the migration (see below).</li>
<li>Match Swift 3 Behavior: This approach adds <code>@objc</code> to your code anywhere the Swift 3 compiler would have inferred it. It is a safe choice but by sprinkling <code>@objc</code> throughout your code you will not see the smaller binary size.</li>
</ul>
<p>If you take the recommended approach Xcode will remind you that you have some extra work to do. This is also the only time you get a link to the <a href="https://help.apple.com/xcode/mac/9.0/index.html?localePath=en.lproj#/deve838b19a1" target="_blank" rel="noopener">migration guide</a>. You can also find this guide in the Xcode help if you look under the “Work in Xcode” section:<br><img src="/assets/images/2017-10-26-003.png" alt=""></p>
<p>Once Xcode has done its best it leaves you with this worrying warning message:<br><img src="/assets/images/2017-10-26-004.png" alt=""></p>
<p>If you check the build settings you will see that the Swift 3 rules for <code>@objc</code>inference are still in effect:<br><img src="/assets/images/2017-10-28-001.png" alt=""></p>
<p>This is helpful as you will get build time and run time warnings any time your code is missing an <code>@objc</code> that the Swift 3 rules would have inferred. So now is a good time to run your tests and check the logs.</p>
<h3 id="Manual-Fixing-objc-Inference"><a href="#Manual-Fixing-objc-Inference" class="headerlink" title="Manual Fixing @objc Inference"></a>Manual Fixing @objc Inference</h3><p>If you are working with a pure Swift project the migrator seems to do a pretty good job of adding <code>@objc</code> where you need it. For example, when you use a method with a <code>#selector</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">button.addTarget(self, action: #selector(doAction(sender:)),</span><br><span class="line">                          for: .touchUpInside)</span><br></pre></td></tr></table></figure>
<p>Since it is <code>UIKit</code> code that calls the <code>doAction</code> method it must be accessible to the Objective-C runtime. Luckily the migrator adds the <code>@objc</code> for you:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">@objc func doAction(sender: UIButton) &#123;</span><br><span class="line">    // Do action here</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>If you are working with a mixed Swift and Objective-C project you are likely to have more work to do. For example, suppose I had this Swift class:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public class MyModel: NSObject &#123;</span><br><span class="line">  var someFlag = false</span><br><span class="line">  func doSomething() &#123;</span><br><span class="line">    print(&quot;doing something&quot;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Under the old Swift 3 rules properties and methods of <code>NSObject</code> subclasses were accessibile from Objective-C (unless they were private).</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">self.model.someFlag = YES;</span><br><span class="line">[self.model doSomething];</span><br></pre></td></tr></table></figure>
<p>In Swift 4 mode this is no longer the case and you should see build and run time warnings prompting you to add <code>@objc</code>:<br><img src="/assets/images/2017-10-28-002.png" alt=""></p>
<p>I can fix the warnings by adding <code>@objc</code> to both the property and method declaration:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public class MyModel: NSObject &#123;</span><br><span class="line">  @objc var someFlag = false</span><br><span class="line">  @objc func doSomething() &#123;</span><br><span class="line">    print(&quot;doing something&quot;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>If you are sure that you want to expose all properties and methods of a class to the Objective-C runtime you can use the <code>@objcMembers</code> annotation:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@objcMembers</span><br><span class="line">public class MyModel: NSObject &#123;</span><br><span class="line">  var someFlag = false         // @objc</span><br><span class="line">  func doSomething() &#123;         // @objc</span><br><span class="line">    print(&quot;doing something&quot;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Using <code>@objcMembers</code> also applies <code>@objc</code> by default to any extensions of the class. It can be convenient to collect methods that should be accessibile from Objective-C in an <code>@objc</code> extension. So another way to write the above would be:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public class MyModel: NSObject &#123;</span><br><span class="line">  @objc var someFlag = false</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@objc extension MyModel &#123;</span><br><span class="line">  func doSomething() &#123;</span><br><span class="line">    print(&quot;doing something&quot;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Note: I cannot move <code>someFlag</code> to the extension as they cannot contain stored properties.</p>
<p>You can also use <code>@nonobjc</code> to override a default <code>@objc</code>. For example in an <code>@objc</code> extension:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@objc extension MyModel &#123;</span><br><span class="line">  func doSomething() &#123;</span><br><span class="line">    print(&quot;doing something&quot;)</span><br><span class="line">  &#125;</span><br><span class="line">  @nonobjc func doNothing() &#123; // Not accessibile from objc</span><br><span class="line">    // ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Completing-The-Migration"><a href="#Completing-The-Migration" class="headerlink" title="Completing The Migration"></a>Completing The Migration</h3><p>Once you are sure you have fixed everything you should disable the Swift 3 <code>@objc</code> inference rules in the build settings for each target:<br><img src="/assets/images/2017-10-29-001.png" alt=""></p>
<p>With the setting switched to <code>Default</code> the warning should go away and you can get back to work.</p>
<p>Source: <a href="https://useyourloaf.com" target="_blank" rel="noopener">useyourloaf</a></p>
</div></article></div></main><footer><div class="paginator"><a href="/2017/11/04/2017/what-the-hell-is-swift-4-access-control/" class="prev">PREV</a><a href="/2017/11/04/2017/chained-foreach/" class="next">NEXT</a></div><div class="copyright"><p>© 2015 - 2018 <a href="https://duc.ninja">Duc Ninja</a> , powered by <a href="https://twitter.com/duccuimia/" target="_blank">@duccuimia</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>
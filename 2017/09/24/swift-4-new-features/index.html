<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title>Swift 4 new features ¬∑ Duc Ninja</title><meta name="description" content="Swift 4 new features - Duc"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://duc.ninja/atom.xml" title="Duc Ninja"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Swift 4 new features</h1><div class="post-info">Sep 24, 2017</div><div class="post-content"><h2 id="One-sided-ranges"><a href="#One-sided-ranges" class="headerlink" title="One-sided ranges"></a>One-sided ranges</h2><p>SE-0172 introduces a new RangeExpression protocol and a set of prefix/postfix operators to form one-sided ranges, i.e. ranges where either the lower or upper bound is unspecified.</p>
<h3 id="Infinite-Sequences"><a href="#Infinite-Sequences" class="headerlink" title="Infinite Sequences"></a>Infinite Sequences</h3><p>You can use a one-sided range to construct an infinite sequence, e.g. as a more flexible replacement for enumerated() when you don‚Äôt want the numbering to start at zero:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> letters = [<span class="string">"a"</span>,<span class="string">"b"</span>,<span class="string">"c"</span>,<span class="string">"d"</span>]</div><div class="line"><span class="keyword">let</span> numberedLetters = <span class="built_in">zip</span>(<span class="number">1</span>..., letters)</div><div class="line"><span class="type">Array</span>(numberedLetters)</div></pre></td></tr></table></figure>
<h3 id="Collection-subscripts"><a href="#Collection-subscripts" class="headerlink" title="Collection subscripts"></a>Collection subscripts</h3><p>When you use a one-sided range for subscripting into a Collection, the collection‚Äôs startIndex or endIndex ‚Äúfills in‚Äù the missing lower or upper bound, respectively.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> numbers = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">9</span>,<span class="number">10</span>]</div><div class="line">numbers[<span class="number">5</span>...] <span class="comment">// instead of numbers[5..&lt;numbers.endIndex]</span></div></pre></td></tr></table></figure>
<h3 id="Pattern-Matching"><a href="#Pattern-Matching" class="headerlink" title="Pattern Matching"></a>Pattern Matching</h3><p>One-sided ranges can be used in pattern matching constructs, e.g. in a case expression in a switch statement. Notice that the compiler can‚Äôt (yet?) determine that the switch is exhaustive, though.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> value = <span class="number">5</span></div><div class="line"><span class="keyword">switch</span> value &#123;</div><div class="line"><span class="keyword">case</span> <span class="number">1</span>...:</div><div class="line">    <span class="built_in">print</span>(<span class="string">"greater than zero"</span>)</div><div class="line"><span class="keyword">case</span> <span class="number">0</span>:</div><div class="line">    <span class="built_in">print</span>(<span class="string">"zero"</span>)</div><div class="line"><span class="keyword">case</span> ..&lt;<span class="number">0</span>:</div><div class="line">    <span class="built_in">print</span>(<span class="string">"less than zero"</span>)</div><div class="line"><span class="keyword">default</span>:</div><div class="line">    <span class="built_in">fatalError</span>(<span class="string">"unreachable"</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="Strings"><a href="#Strings" class="headerlink" title="Strings"></a>Strings</h2><h3 id="Multi-line-string-literals"><a href="#Multi-line-string-literals" class="headerlink" title="Multi-line string literals"></a>Multi-line string literals</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> multilineString = <span class="string">""</span><span class="string">"</span></div><div class="line"><span class="string">    This is a multi-line string.</span></div><div class="line"><span class="string">    You don't have to escape "</span>quotes<span class="string">" in here.</span></div><div class="line"><span class="string">    String interpolation works as expected: 2 + 3 = <span class="subst">\(<span class="number">2</span> + <span class="number">3</span>)</span></span></div><div class="line"><span class="string">    The position of the closing delimiter</span></div><div class="line"><span class="string">      controls whitespace stripping.</span></div><div class="line"><span class="string">    "</span><span class="string">""</span></div><div class="line"><span class="built_in">print</span>(multilineString)</div><div class="line"><span class="built_in">print</span>(<span class="string">"---"</span>)</div></pre></td></tr></table></figure>
<h3 id="Escaping-newlines-in-string-literals"><a href="#Escaping-newlines-in-string-literals" class="headerlink" title="Escaping newlines in string literals"></a>Escaping newlines in string literals</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> escapedNewline = <span class="string">""</span><span class="string">"</span></div><div class="line"><span class="string">    To omit a line break, \</span></div><div class="line"><span class="string">    add a backslash at the end of a line.</span></div><div class="line"><span class="string">    "</span><span class="string">""</span></div><div class="line"><span class="built_in">print</span>(escapedNewline)</div><div class="line"><span class="built_in">print</span>(<span class="string">"---"</span>)</div></pre></td></tr></table></figure>
<h3 id="String-is-a-Collection-again"><a href="#String-is-a-Collection-again" class="headerlink" title="String is a Collection again"></a>String is a Collection again</h3><p>SE-0163 is the first part of the revised string model for Swift 4. The biggest change is that String is a Collection again (as it used to be in Swift 1.x), i.e. the functionality of String.CharacterView has been folded into the parent type. (The other views, UnicodeScalarView, UTF8View, and UTF16View, still exist.)</p>
<p>Another string-related change is a redesign of the String.Index type (SE-0180)</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> greeting = <span class="string">"Hello, üòú!"</span></div><div class="line"><span class="comment">// No need to drill down to .characters</span></div><div class="line">greeting.<span class="built_in">count</span></div><div class="line"><span class="keyword">for</span> char <span class="keyword">in</span> greeting &#123;</div><div class="line">    <span class="built_in">print</span>(char)</div><div class="line">&#125;</div><div class="line"><span class="built_in">print</span>(<span class="string">"---"</span>)</div></pre></td></tr></table></figure>
<h3 id="Substring-is-the-new-type-for-string-slices"><a href="#Substring-is-the-new-type-for-string-slices" class="headerlink" title="Substring is the new type for string slices"></a>Substring is the new type for string slices</h3><p>String slices are now instances of type Substring. Both String and Substring conform to StringProtocol. Almost the entire string API will live in StringProtocol so that String and Substring behave largely the same.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> comma = greeting.index(of: <span class="string">","</span>)!</div><div class="line"><span class="keyword">let</span> substring = greeting[..&lt;comma]</div><div class="line">type(of: substring)</div><div class="line"><span class="comment">// Most String APIs can be called on Substring</span></div><div class="line"><span class="built_in">print</span>(substring.uppercased())</div><div class="line"><span class="built_in">print</span>(<span class="string">"---"</span>)</div></pre></td></tr></table></figure>
<h3 id="Character-unicodeScalars-property"><a href="#Character-unicodeScalars-property" class="headerlink" title="Character.unicodeScalars property"></a>Character.unicodeScalars property</h3><p>You can now access the code points of a Character directly without having to convert it to a String first (SE-0178):</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> <span class="built_in">c</span>: <span class="type">Character</span> = <span class="string">"üá™üá∫"</span></div><div class="line"><span class="type">Array</span>(<span class="built_in">c</span>.unicodeScalars)</div></pre></td></tr></table></figure>
<h3 id="Converting-between-Range-and-NSRange"><a href="#Converting-between-Range-and-NSRange" class="headerlink" title="Converting between Range and NSRange"></a>Converting between Range<string.index> and NSRange</string.index></h3><p>Foundation comes with new initializers on NSRange and Range<string.index> to convert between the two, removing the need to manually compute UTF-16 offsets. This makes it easier to use APIs that still work on NSRanges, such as NSRegularExpression and NSAttributedString.</string.index></p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Given a String range</span></div><div class="line"><span class="keyword">let</span> string = <span class="string">"Hello üë©üèΩ‚Äçüåæüë®üèº‚ÄçüöíüíÉüèæ"</span></div><div class="line"><span class="keyword">let</span> index = string.index(of: <span class="type">Character</span>(<span class="string">"üë©üèΩ‚Äçüåæ"</span>))!</div><div class="line"><span class="keyword">let</span> range = index...</div><div class="line"></div><div class="line"><span class="comment">// Convert the String range to an NSRange</span></div><div class="line"><span class="keyword">import</span> Foundation</div><div class="line"></div><div class="line"><span class="keyword">let</span> nsRange = <span class="type">NSRange</span>(range, <span class="keyword">in</span>: string)</div><div class="line">nsRange.length <span class="comment">// length in UTF-16 code units</span></div><div class="line">string[range].<span class="built_in">count</span> <span class="comment">// length in Characters</span></div><div class="line"><span class="built_in">assert</span>(nsRange.length == string[range].utf16.<span class="built_in">count</span>)</div><div class="line"></div><div class="line"><span class="comment">// Use the NSRange to format an attributed string</span></div><div class="line"><span class="keyword">import</span> UIKit</div><div class="line"></div><div class="line"><span class="keyword">let</span> formatted = <span class="type">NSMutableAttributedString</span>(string: string, attributes: [.font: <span class="type">UIFont</span>.systemFont(ofSize: <span class="number">14</span>)])</div><div class="line">formatted.addAttribute(.font, value: <span class="type">UIFont</span>.systemFont(ofSize: <span class="number">48</span>), range: nsRange)</div><div class="line"></div><div class="line"><span class="comment">// NSAttributedString APIs return NSRange</span></div><div class="line"><span class="keyword">let</span> lastCharacterIndex = string.index(before: string.endIndex)</div><div class="line"><span class="keyword">let</span> lastCharacterNSRange = <span class="type">NSRange</span>(lastCharacterIndex..., <span class="keyword">in</span>: string)</div><div class="line"><span class="keyword">var</span> attributesNSRange = <span class="type">NSRange</span>()</div><div class="line"><span class="number">_</span> = formatted.attributes(at: lastCharacterNSRange.location, longestEffectiveRange: &amp;attributesNSRange, <span class="keyword">in</span>: nsRange)</div><div class="line">attributesNSRange</div><div class="line"></div><div class="line"><span class="comment">// Convert the NSRange back to Range&lt;String.Index&gt; to use it with String</span></div><div class="line"><span class="keyword">let</span> attributesRange = <span class="type">Range</span>(attributesNSRange, <span class="keyword">in</span>: string)!</div><div class="line">string[attributesRange]</div></pre></td></tr></table></figure>
<h2 id="Private-declarations-visible-in-same-file-extensions"><a href="#Private-declarations-visible-in-same-file-extensions" class="headerlink" title="Private declarations visible in same-file extensions"></a>Private declarations visible in same-file extensions</h2><p>SE-0169 changes the access control rules such that private declarations are also visible inside extensions of the parent type <em>in the same file</em>. This makes it possible to split your type definition into multiple extensions and still use private for most ‚Äúprivate‚Äù members, reducing the need for the unloved fileprivate keyword.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">SortedArray</span>&lt;<span class="title">Element</span>: <span class="title">Comparable</span>&gt; </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">var</span> storage: [<span class="type">Element</span>] = []</div><div class="line">    <span class="keyword">init</span>(unsorted: [<span class="type">Element</span>]) &#123;</div><div class="line">        storage = unsorted.sorted()</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">extension</span> <span class="title">SortedArray</span> </span>&#123;</div><div class="line">    <span class="keyword">mutating</span> <span class="function"><span class="keyword">func</span> <span class="title">insert</span><span class="params">(<span class="number">_</span> element: Element)</span></span> &#123;</div><div class="line">        <span class="comment">// storage is visible here</span></div><div class="line">        storage.append(element)</div><div class="line">        storage.<span class="built_in">sort</span>()</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">let</span> array = <span class="type">SortedArray</span>(unsorted: [<span class="number">3</span>,<span class="number">1</span>,<span class="number">2</span>])</div><div class="line"></div><div class="line"><span class="comment">// storage is _not_ visible here. It would be if it were fileprivate.</span></div><div class="line"><span class="comment">//array.storage // error: 'storage' is inaccessible due to 'private' protection level</span></div></pre></td></tr></table></figure>
<h2 id="Key-paths"><a href="#Key-paths" class="headerlink" title="Key paths"></a>Key paths</h2><p>One of the headline features of Swift 4 is the new key paths model described in SE-0161. Unlike the string-based key paths in Cocoa, Swift key paths are strongly typed.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Person</span> </span>&#123;</div><div class="line">    <span class="keyword">var</span> name: <span class="type">String</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Book</span> </span>&#123;</div><div class="line">    <span class="keyword">var</span> title: <span class="type">String</span></div><div class="line">    <span class="keyword">var</span> authors: [<span class="type">Person</span>]</div><div class="line">    <span class="keyword">var</span> primaryAuthor: <span class="type">Person</span> &#123;</div><div class="line">        <span class="keyword">return</span> authors.first!</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">let</span> abelson = <span class="type">Person</span>(name: <span class="string">"Harold Abelson"</span>)</div><div class="line"><span class="keyword">let</span> sussman = <span class="type">Person</span>(name: <span class="string">"Gerald Jay Sussman"</span>)</div><div class="line"><span class="keyword">let</span> book = <span class="type">Book</span>(title: <span class="string">"Structure and Interpretation of Computer Programs"</span>, authors: [abelson, sussman])</div></pre></td></tr></table></figure>
<p>Key paths are formed by starting at a root type and drilling down any combination of property and subscript names.</p>
<p>You write a key path by starting with a backslash: \Book.title. Every type automatically gets a [keyPath: ‚Ä¶] subscript to get or set the value at the specified key path.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">book[keyPath: \<span class="type">Book</span>.title]</div><div class="line"><span class="comment">// Key paths can drill down multiple levels</span></div><div class="line"><span class="comment">// They also work for computed properties</span></div><div class="line">book[keyPath: \<span class="type">Book</span>.primaryAuthor.name]</div></pre></td></tr></table></figure>
<p>Key paths are objects that can be stored and manipulated. For example, you can append additional segments to a key path to drill down further.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> authorKeyPath = \<span class="type">Book</span>.primaryAuthor</div><div class="line">type(of: authorKeyPath)</div><div class="line"><span class="comment">// You can omit the type name if the compiler can infer it</span></div><div class="line"><span class="keyword">let</span> nameKeyPath = authorKeyPath.appending(path: \.name)</div><div class="line">book[keyPath: nameKeyPath]</div></pre></td></tr></table></figure>
<h3 id="Key-paths-for-subscripts"><a href="#Key-paths-for-subscripts" class="headerlink" title="Key paths for subscripts"></a>Key paths for subscripts</h3><h3 id="Type-safe-KVO-with-key-paths"><a href="#Type-safe-KVO-with-key-paths" class="headerlink" title="Type-safe KVO with key paths"></a>Type-safe KVO with key paths</h3><p>The key-value observing API in Foundation has been revamped to take full advantage of the new type-safe key paths. It is much easier to use than the old API.</p>
<p>Notice that KVO depends on the Objective-C runtime. It only works in subclasses of NSObject, and any observable property must be declared with @objc dynamic.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> Foundation</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Child</span>: <span class="title">NSObject</span> </span>&#123;</div><div class="line">    <span class="keyword">let</span> name: <span class="type">String</span></div><div class="line">    <span class="comment">// KVO-enabled properties must be @objc dynamic</span></div><div class="line">    <span class="meta">@objc</span> <span class="keyword">dynamic</span> <span class="keyword">var</span> age: <span class="type">Int</span></div><div class="line"></div><div class="line">    <span class="keyword">init</span>(name: <span class="type">String</span>, age: <span class="type">Int</span>) &#123;</div><div class="line">        <span class="keyword">self</span>.name = name</div><div class="line">        <span class="keyword">self</span>.age = age</div><div class="line">        <span class="keyword">super</span>.<span class="keyword">init</span>()</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">func</span> <span class="title">celebrateBirthday</span><span class="params">()</span></span> &#123;</div><div class="line">        age += <span class="number">1</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Set up KVO</span></div><div class="line"><span class="keyword">let</span> mia = <span class="type">Child</span>(name: <span class="string">"Mia"</span>, age: <span class="number">5</span>)</div><div class="line"><span class="keyword">let</span> observation = mia.observe(\.age, options: [.initial, .old]) &#123; (child, change) <span class="keyword">in</span></div><div class="line">    <span class="keyword">if</span> <span class="keyword">let</span> oldValue = change.oldValue &#123;</div><div class="line">        <span class="built_in">print</span>(<span class="string">"<span class="subst">\(child.name)</span>‚Äôs age changed from <span class="subst">\(oldValue)</span> to <span class="subst">\(child.age)</span>"</span>)</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="built_in">print</span>(<span class="string">"<span class="subst">\(child.name)</span>‚Äôs age is now <span class="subst">\(child.age)</span>"</span>)</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Trigger KVO (see output in the console)</span></div><div class="line">mia.celebrateBirthday()</div><div class="line"></div><div class="line"><span class="comment">// Deiniting or invalidating the observation token ends the observation</span></div><div class="line">observation.invalidate()</div><div class="line"></div><div class="line"><span class="comment">// This doesn't trigger the KVO handler anymore</span></div><div class="line">mia.celebrateBirthday()</div></pre></td></tr></table></figure>
<h2 id="Encoding-and-decoding"><a href="#Encoding-and-decoding" class="headerlink" title="Encoding and decoding"></a>Encoding and decoding</h2><p>SE-0166: Swift Archival &amp; Serialization defines a way for any Swift type (classes, structs, and enums) to describe how to archive and serialize itself. Types can make themselves (un-)archivable by conforming to the Codable protocol.</p>
<p>In many cases adding the Codable conformance will be all you have to do for your custom types because the compiler can generate a default implementation if all of the types‚Äô members are themselves Codable. You can also override the default behavior if you need to customize how your type encodes itself. There is a lot to this topic ‚Äî make sure to read the proposal for details.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Make a custom type archivable by conforming it (and all its members) to Codable</span></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Card</span>: <span class="title">Codable</span>, <span class="title">Equatable</span> </span>&#123;</div><div class="line">    <span class="class"><span class="keyword">enum</span> <span class="title">Suit</span>: <span class="title">String</span>, <span class="title">Codable</span> </span>&#123;</div><div class="line">        <span class="keyword">case</span> clubs, spades, hearts, diamonds</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="class"><span class="keyword">enum</span> <span class="title">Rank</span>: <span class="title">Int</span>, <span class="title">Codable</span> </span>&#123;</div><div class="line">        <span class="keyword">case</span> two = <span class="number">2</span>, three, four, five, six, seven, eight, nine, ten, jack, queen, king, ace</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">var</span> suit: <span class="type">Suit</span></div><div class="line">    <span class="keyword">var</span> rank: <span class="type">Rank</span></div><div class="line"></div><div class="line">    <span class="keyword">static</span> <span class="function"><span class="keyword">func</span> ==<span class="params">(lhs: Card, rhs: Card)</span></span> -&gt; <span class="type">Bool</span> &#123;</div><div class="line">        <span class="keyword">return</span> lhs.suit == rhs.suit &amp;&amp; lhs.rank == rhs.rank</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">let</span> hand = [<span class="type">Card</span>(suit: .clubs, rank: .ace), <span class="type">Card</span>(suit: .hearts, rank: .queen)]</div></pre></td></tr></table></figure>
<h3 id="Encoding"><a href="#Encoding" class="headerlink" title="Encoding"></a>Encoding</h3><p>Once you have a Codable value, you need to pass it to an encoder in order to archive it.</p>
<p>You can write your own encoders and decoders that make use of the Codable infrastructure, but Swift will also come with a built-in set of encoders and decoders for JSON (JSONEncoder and JSONDecoder) and property lists (PropertyListEncoder and PropertyListDecoder). These are defined in SE-0167. NSKeyedArchiver will also support all Codable types.</p>
<p>In its simplest form, encoding is just two lines of code: create and encoder and ask it to encode your value. Most encoders include properties you can set to customize the output.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> Foundation</div><div class="line"></div><div class="line"><span class="keyword">var</span> encoder = <span class="type">JSONEncoder</span>()</div><div class="line"></div><div class="line"><span class="comment">// Optional properties offered by JSONEncoder for customizing output</span></div><div class="line">encoder.outputFormatting = [.prettyPrinted] <span class="comment">// another option: .sortedKeys</span></div><div class="line">encoder.dataEncodingStrategy</div><div class="line">encoder.dateEncodingStrategy</div><div class="line">encoder.nonConformingFloatEncodingStrategy</div><div class="line"></div><div class="line"><span class="comment">// Every encoder and decoder has a userInfo property to pass custom configuration down the chain. The supported keys depend on the specific encode/decoder.</span></div><div class="line">encoder.userInfo</div><div class="line"></div><div class="line"><span class="keyword">let</span> jsonData = <span class="keyword">try</span> encoder.encode(hand)</div><div class="line"><span class="type">String</span>(data: jsonData, encoding: .utf8)</div></pre></td></tr></table></figure>
<h3 id="Decoding"><a href="#Decoding" class="headerlink" title="Decoding"></a>Decoding</h3><p>Like encoding, decoding consists of two steps: create a decoder and pass it a Data value to decode. Notice that you also pass the expected type of the decoded value ([Card], or Array<card>, in this example). Don‚Äôt forget to handle decoding errors in production code.</card></p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> decoder = <span class="type">JSONDecoder</span>()</div><div class="line"><span class="keyword">let</span> decodedHand = <span class="keyword">try</span> decoder.decode([<span class="type">Card</span>].<span class="keyword">self</span>, from: jsonData)</div><div class="line">type(of: decodedHand)</div><div class="line"><span class="built_in">assert</span>(decodedHand == hand)</div></pre></td></tr></table></figure>
<h2 id="Associated-type-constraints"><a href="#Associated-type-constraints" class="headerlink" title="Associated type constraints"></a>Associated type constraints</h2><p>SE-0142: associated types in protocols can now be constrained with where clauses. This seemingly small change makes the type system much more expressive and facilitates a significant simplification of the standard library. In particular, working with Sequence and Collection is a lot more intuitive in Swift 4.</p>
<p>Sequence.Element</p>
<p>Sequence now has its own Element associated type. This is made possible by the new generics feature because associatedtype Element where Element == Iterator.Element can now be expressed in the type system.</p>
<p>Anywhere you had to write Iterator.Element in Swift 3, you can now just write Element:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">extension</span> <span class="title">Sequence</span> <span class="title">where</span> <span class="title">Element</span>: <span class="title">Numeric</span> </span>&#123;</div><div class="line">    <span class="keyword">var</span> sum: <span class="type">Element</span> &#123;</div><div class="line">        <span class="keyword">var</span> result: <span class="type">Element</span> = <span class="number">0</span></div><div class="line">        <span class="keyword">for</span> element <span class="keyword">in</span> <span class="keyword">self</span> &#123;</div><div class="line">            result += element</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> result</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">[<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>].sum</div></pre></td></tr></table></figure>
<p>Another example: In Swift 3, this extension required more constraints because the type system could not express the idea that the elements of Collection‚Äôs associated Indices type had the same type as <code>Collection.Index</code>:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">extension</span> <span class="title">MutableCollection</span> </span>&#123;</div><div class="line">    <span class="comment">/// Maps over the elements in the collection in place, replacing the existing</span></div><div class="line">    <span class="comment">/// elements with their transformed values.</span></div><div class="line">    <span class="keyword">mutating</span> <span class="function"><span class="keyword">func</span> <span class="title">mapInPlace</span><span class="params">(<span class="number">_</span> transform: <span class="params">(Element)</span></span></span> <span class="keyword">throws</span> -&gt; <span class="type">Element</span>) <span class="keyword">rethrows</span> &#123;</div><div class="line">        <span class="keyword">for</span> index <span class="keyword">in</span> <span class="built_in">indices</span> &#123;</div><div class="line">            <span class="keyword">self</span>[index] = <span class="keyword">try</span> transform(<span class="keyword">self</span>[index])</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="Dictionary-and-Set-enhancements"><a href="#Dictionary-and-Set-enhancements" class="headerlink" title="Dictionary and Set enhancements"></a>Dictionary and Set enhancements</h2><p><a href="https://github.com/apple/swift-evolution/blob/master/proposals/0165-dict.md" title="Swift Evolution Proposal SE-0165: Dictionary and Set Enhancements" target="_blank" rel="external">SE-0165</a> adds several nice enhancements to <code>Dictionary</code> and <code>Set</code>.</p>
<h3 id="Sequence-based-initializer"><a href="#Sequence-based-initializer" class="headerlink" title="Sequence-based initializer"></a>Sequence-based initializer</h3><p> Create a dictionary from a sequence of key-value pairs.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> names = [<span class="string">"Cagney"</span>, <span class="string">"Lacey"</span>, <span class="string">"Bensen"</span>]</div><div class="line"></div><div class="line"><span class="keyword">let</span> dict = <span class="type">Dictionary</span>(uniqueKeysWithValues: <span class="built_in">zip</span>(<span class="number">1</span>..., names))</div><div class="line"></div><div class="line">dict[<span class="number">2</span>]</div></pre></td></tr></table></figure>
<h3 id="Merging-initializer-and-merge-method"><a href="#Merging-initializer-and-merge-method" class="headerlink" title="Merging initializer and merge method"></a>Merging initializer and <code>merge</code> method</h3><p> Specify how duplicate keys should be handled when creating a dictionary from a sequence or merging a sequence into an existing dictionary.</p>
<p> Merging initializer:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> duplicates = [(<span class="string">"a"</span>, <span class="number">1</span>), (<span class="string">"b"</span>, <span class="number">2</span>), (<span class="string">"a"</span>, <span class="number">3</span>), (<span class="string">"b"</span>, <span class="number">4</span>)]</div><div class="line"></div><div class="line"><span class="keyword">let</span> letters = <span class="type">Dictionary</span>(duplicates, uniquingKeysWith: &#123; (first, <span class="number">_</span>) <span class="keyword">in</span> first &#125;)</div><div class="line"></div><div class="line">letters</div></pre></td></tr></table></figure>
<p> <code>merge</code> method:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">let</span> defaults = [<span class="string">"darkUI"</span>: <span class="literal">false</span>, <span class="string">"energySaving"</span>: <span class="literal">false</span>, <span class="string">"smoothScrolling"</span>: <span class="literal">false</span>]</div><div class="line"></div><div class="line"><span class="keyword">var</span> options = [<span class="string">"darkUI"</span>: <span class="literal">true</span>, <span class="string">"energySaving"</span>: <span class="literal">false</span>]</div><div class="line"></div><div class="line">options.merge(defaults) &#123; (old, <span class="number">_</span>) <span class="keyword">in</span> old &#125;</div><div class="line"></div><div class="line">options</div></pre></td></tr></table></figure>
<h3 id="Subscript-with-default-value"><a href="#Subscript-with-default-value" class="headerlink" title="Subscript with default value"></a>Subscript with default value</h3><p> You can provide a default value that will be returned for missing keys as a subscript argument, making the return type non-optional.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">dict[<span class="number">4</span>, <span class="keyword">default</span>: <span class="string">"(unknown)"</span>]</div></pre></td></tr></table></figure>
<p> This is especially useful when you want to mutate a value through the subscript:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">let</span> source = <span class="string">"how now brown cow"</span></div><div class="line"><span class="keyword">var</span> frequencies: [<span class="type">Character</span>: <span class="type">Int</span>] = [:]</div><div class="line"><span class="keyword">for</span> <span class="built_in">c</span> <span class="keyword">in</span> source &#123;</div><div class="line">    frequencies[<span class="built_in">c</span>, <span class="keyword">default</span>: <span class="number">0</span>] += <span class="number">1</span></div><div class="line">&#125;</div><div class="line">frequencies</div></pre></td></tr></table></figure>
<h3 id="Dictionary-specific-map-and-filter"><a href="#Dictionary-specific-map-and-filter" class="headerlink" title="Dictionary-specific map and filter"></a>Dictionary-specific <code>map</code> and <code>filter</code></h3><p> <code>filter</code> returns a <code>Dictionary</code> and not an <code>Array</code>. Similarly, the new <code>mapValues</code> method transforms the values while preserving the dictionary structure.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> filtered = dict.<span class="built_in">filter</span> &#123;</div><div class="line">    $<span class="number">0</span>.key % <span class="number">2</span> == <span class="number">0</span></div><div class="line">&#125;</div><div class="line"></div><div class="line">type(of: filtered)</div><div class="line"></div><div class="line"><span class="keyword">let</span> mapped = dict.mapValues &#123; value <span class="keyword">in</span></div><div class="line">    value.uppercased()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p> <code>Set.filter</code> also returns a <code>Set</code> now and not an <code>Array</code>.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> <span class="keyword">set</span>: <span class="type">Set</span> = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>]</div><div class="line"><span class="keyword">let</span> filteredSet = <span class="keyword">set</span>.<span class="built_in">filter</span> &#123; $<span class="number">0</span> % <span class="number">2</span> == <span class="number">0</span> &#125;</div><div class="line">type(of: filteredSet)</div></pre></td></tr></table></figure>
<h3 id="Grouping-a-sequence"><a href="#Grouping-a-sequence" class="headerlink" title="Grouping a sequence"></a>Grouping a sequence</h3><p> Group a sequence of values into buckets, e.g. partition words in a word list by their initial letter. This is one of my favorites.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> contacts = [<span class="string">"Julia"</span>, <span class="string">"Susan"</span>, <span class="string">"John"</span>, <span class="string">"Alice"</span>, <span class="string">"Alex"</span>]</div><div class="line"><span class="keyword">let</span> grouped = <span class="type">Dictionary</span>(grouping: contacts, by: &#123; $<span class="number">0</span>.first! &#125;)</div></pre></td></tr></table></figure>
<h2 id="MutableCollection-swapAt-method"><a href="#MutableCollection-swapAt-method" class="headerlink" title="MutableCollection.swapAt method"></a>MutableCollection.swapAt method</h2><p>SE-0173 introduces a new method for swapping two elements in a collection. Unlike the existing swap(<em>:</em>:) function, swapAt(<em>:</em>:) takes the indices of the elements to be swapped, not the elements themselves (via inout arguments).</p>
<p>The reason for this addition is that swap with two inout arguments is incompatible with the new exclusive memory access rules proposed in SE-0176. The existing swap(<em>:</em>:) function will no longer work for swapping two elements of the same collection.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> numbers = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>]</div><div class="line"></div><div class="line"><span class="comment">// Illegal in Swift 4:</span></div><div class="line"><span class="comment">// error: simultaneous accesses to var 'numbers', but modification requires exclusive access; consider copying to a local variable</span></div><div class="line"><span class="comment">//swap(&amp;numbers[3], &amp;numbers[4])</span></div><div class="line"></div><div class="line"><span class="comment">// This is the new way to do this:</span></div><div class="line">numbers.swapAt(<span class="number">0</span>,<span class="number">1</span>)</div><div class="line">numbers</div></pre></td></tr></table></figure>
<h2 id="reduce-with-inout"><a href="#reduce-with-inout" class="headerlink" title="reduce with inout"></a>reduce with inout</h2><p>SE-0171 adds a variant of reduce in which the partial result is passed inout to the combine function. This can be a significant performance boost for algorithms that use reduce to incrementally build a sequence by eliminating copies of the intermediate results.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">extension</span> <span class="title">Sequence</span> <span class="title">where</span> <span class="title">Element</span>: <span class="title">Equatable</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">func</span> <span class="title">removingConsecutiveDuplicates</span><span class="params">()</span></span> -&gt; [<span class="type">Element</span>] &#123;</div><div class="line">        <span class="keyword">return</span> <span class="built_in">reduce</span>(into: []) &#123; (result: <span class="keyword">inout</span> [<span class="type">Element</span>], element) <span class="keyword">in</span></div><div class="line">            <span class="keyword">if</span> result.last != element &#123;</div><div class="line">                result.append(element)</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">[<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">4</span>].removingConsecutiveDuplicates()</div></pre></td></tr></table></figure>
<h2 id="Generic-subscripts"><a href="#Generic-subscripts" class="headerlink" title="Generic subscripts"></a>Generic subscripts</h2><p>Courtesy of SE-0148, subscripts can now have generic arguments and/or return types.</p>
<p>The canonical example is a type that represents JSON data: you can define a generic subscript to have the caller‚Äôs context define the expected return type.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">JSON</span> </span>&#123;</div><div class="line">    <span class="keyword">fileprivate</span> <span class="keyword">var</span> storage: [<span class="type">String</span>:<span class="type">Any</span>]</div><div class="line"></div><div class="line">    <span class="keyword">init</span>(dictionary: [<span class="type">String</span>:<span class="type">Any</span>]) &#123;</div><div class="line">        <span class="keyword">self</span>.storage = dictionary</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">subscript</span>&lt;<span class="type">T</span>&gt;(key: <span class="type">String</span>) -&gt; <span class="type">T</span>? &#123;</div><div class="line">        <span class="keyword">return</span> storage[key] <span class="keyword">as</span>? <span class="type">T</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">let</span> json = <span class="type">JSON</span>(dictionary: [</div><div class="line">    <span class="string">"name"</span>: <span class="string">"Berlin"</span>,</div><div class="line">    <span class="string">"country"</span>: <span class="string">"de"</span>,</div><div class="line">    <span class="string">"population"</span>: <span class="number">3_500_500</span></div><div class="line">    ])</div><div class="line"></div><div class="line"><span class="comment">// No need to use as? Int</span></div><div class="line"><span class="keyword">let</span> population: <span class="type">Int</span>? = json[<span class="string">"population"</span>]</div></pre></td></tr></table></figure>
<p>Another example: a subscript on Collection that takes a generic sequence of indices and returns an array of the values at these indices:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">extension</span> <span class="title">Collection</span> </span>&#123;</div><div class="line">    <span class="keyword">subscript</span>&lt;<span class="type">Indices</span>: <span class="type">Sequence</span>&gt;(<span class="built_in">indices</span> <span class="built_in">indices</span>: <span class="type">Indices</span>) -&gt; [<span class="type">Element</span>] <span class="keyword">where</span> <span class="type">Indices</span>.<span class="type">Element</span> == <span class="type">Index</span> &#123;</div><div class="line">        <span class="keyword">var</span> result: [<span class="type">Element</span>] = []</div><div class="line">        <span class="keyword">for</span> index <span class="keyword">in</span> <span class="built_in">indices</span> &#123;</div><div class="line">            result.append(<span class="keyword">self</span>[index])</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> result</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">let</span> words = <span class="string">"Lorem ipsum dolor sit amet"</span>.<span class="built_in">split</span>(separator: <span class="string">" "</span>)</div><div class="line">words[<span class="built_in">indices</span>: [<span class="number">1</span>,<span class="number">2</span>]]</div></pre></td></tr></table></figure>
<h2 id="New-integer-protocols"><a href="#New-integer-protocols" class="headerlink" title="New integer protocols"></a>New integer protocols</h2><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> a: <span class="type">Int</span> = <span class="number">5</span></div><div class="line"><span class="keyword">let</span> b: <span class="type">UInt</span> = <span class="number">5</span></div><div class="line"><span class="keyword">let</span> <span class="built_in">c</span>: <span class="type">Int8</span> = -<span class="number">10</span></div><div class="line">a == b <span class="comment">// doesn't compile in Swift 3</span></div><div class="line">a &gt; <span class="built_in">c</span>  <span class="comment">// doesn't compile in Swift 3</span></div><div class="line">a + b <span class="comment">// doesn't compile in either Swift 3 or 4</span></div></pre></td></tr></table></figure>
<p>There‚Äôs a lot more to the new protocols. Here are a few examples of new properties and methods:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Get information about the bit pattern</span></div><div class="line"><span class="number">0xFFFF</span>.words</div><div class="line"><span class="number">0b11001000</span>.trailingZeroBitCount</div><div class="line">(<span class="number">0b00001100</span> <span class="keyword">as</span> <span class="type">UInt8</span>).leadingZeroBitCount</div><div class="line"><span class="number">0b110001</span>.nonzeroBitCount</div><div class="line"></div><div class="line"><span class="comment">// Artihmetic with overflow reporting</span></div><div class="line"><span class="keyword">let</span> (partialValue, overflow) = <span class="type">Int32</span>.<span class="built_in">max</span>.addingReportingOverflow(<span class="number">1</span>)</div><div class="line">partialValue</div><div class="line">overflow</div><div class="line"></div><div class="line"><span class="comment">// Calculate the full result of a multiplication that would otherwise overflow</span></div><div class="line"><span class="keyword">let</span> x: <span class="type">UInt8</span> = <span class="number">100</span></div><div class="line"><span class="keyword">let</span> y: <span class="type">UInt8</span> = <span class="number">20</span></div><div class="line"><span class="keyword">let</span> result = x.multipliedFullWidth(by: y)</div><div class="line">result.high</div><div class="line">result.low</div></pre></td></tr></table></figure>
<h3 id="DoubleWidth"><a href="#DoubleWidth" class="headerlink" title="DoubleWidth"></a>DoubleWidth</h3><p>The new DoubleWidth<t> type is supposed to make it possible to create wider fixed-width integer types from the ones available in the standard library. It‚Äôs implemented in the Swift master branch, but isn‚Äôt included in Swift 4.0. Expect it to be part of the next point release.</t></p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//var veryBigNumber = DoubleWidth&lt;Int64&gt;(Int64.max) // error: Use of unresolved identifier 'DoubleWidth'</span></div><div class="line"><span class="comment">//veryBigNumber + 1</span></div></pre></td></tr></table></figure>
<h2 id="NSNumber-bridging"><a href="#NSNumber-bridging" class="headerlink" title="NSNumber bridging"></a>NSNumber bridging</h2><p>SE-0170 fixes some dangerous behavior when bridging between native Swift number types and NSNumber.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> Foundation</div><div class="line"></div><div class="line"><span class="keyword">let</span> n = <span class="type">NSNumber</span>(value: <span class="type">UInt32</span>(<span class="number">543</span>))</div><div class="line"><span class="keyword">let</span> v = n <span class="keyword">as</span>? <span class="type">Int8</span> <span class="comment">// nil in Swift 4. This would be 31 in Swift 3 (try it!).</span></div></pre></td></tr></table></figure>
<h3 id="Floating-point-NSNumber-bridging"><a href="#Floating-point-NSNumber-bridging" class="headerlink" title="Floating-point NSNumber bridging"></a>Floating-point NSNumber bridging</h3><p>Initially, in Xcode 9 beta 1, the same rules applied to floating-point bridging, which meant for example that NSNumber(value: 0.1) as? Float would return nil because the double-precision representation of 0.1 is not exactly representable as a single-precision float. This change was reverted to the Swift 3 behavior.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="type">NSNumber</span>(value: <span class="number">0.1</span>) <span class="keyword">as</span>? <span class="type">Double</span></div><div class="line"><span class="type">NSNumber</span>(value: <span class="number">0.1</span>) <span class="keyword">as</span>? <span class="type">Float</span> <span class="comment">// Returned nil in Xcode 9 beta 1, now changed back to Swift 3 behavior</span></div></pre></td></tr></table></figure>
<h2 id="Limiting-objc-inference"><a href="#Limiting-objc-inference" class="headerlink" title="Limiting @objc inference"></a>Limiting @objc inference</h2><p>In many places where Swift 3 automatically inferred a declaration to be @objc (and thus visible from Objective-C), Swift 4 doesn‚Äôt do this anymore (SE-0160). Most importantly, NSObject subclasses no longer infer @objc for their members.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> Foundation</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span> : <span class="title">NSObject</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">func</span> <span class="title">foo</span><span class="params">()</span></span> &#123; &#125;       <span class="comment">// not exposed to Objective-C in Swift 4</span></div><div class="line">    <span class="meta">@objc</span> <span class="function"><span class="keyword">func</span> <span class="title">bar</span><span class="params">()</span></span> &#123; &#125; <span class="comment">// explicitly exposed to Objective-C</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="objcMembers-shorthand"><a href="#objcMembers-shorthand" class="headerlink" title="@objcMembers shorthand"></a>@objcMembers shorthand</h3><p>If want to expose all or most members of a class to Objective-C, you can use the @objcMembers attribute on the class declaration to save you some typing:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@objc</span>Members</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass2</span> : <span class="title">NSObject</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">func</span> <span class="title">foo</span><span class="params">()</span></span> &#123; &#125;             <span class="comment">// implicitly @objc</span></div><div class="line">    <span class="function"><span class="keyword">func</span> <span class="title">bar</span><span class="params">()</span></span> -&gt; (<span class="type">Int</span>, <span class="type">Int</span>) &#123; <span class="comment">// not @objc, because tuples aren't representable in Objective-C (unchanged from Swift 3)</span></div><div class="line">        <span class="keyword">return</span> (<span class="number">0</span>, <span class="number">0</span>)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Use @nonobjc on an extension to disable @objc inference (through @objcMembers) for all declarations in the extension.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@nonobjc</span> <span class="class"><span class="keyword">extension</span> <span class="title">MyClass2</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">func</span> <span class="title">wobble</span><span class="params">()</span></span> &#123; &#125; <span class="comment">// not @objc, despite @objcMembers</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>dynamic doesn‚Äôt imply @objc</p>
<p>Also note that dynamic doesn‚Äôt imply @objc anymore. If you want to use features that depend on the dynamic dispatch of the Objective-C runtime (such as KVO), you may need to add @objc dynamic to a declaration. See the Key paths page for a KVO example.</p>
<p>Since dynamic is currently implemented in terms of the Objective-C runtime, this means all current usages of dynamic also have to be @objc. While this sounds redundant at the moment, it‚Äôs an important step on the way to eventually make dynamic a pure Swift feature in a future version of the language.</p>
<h2 id="Composing-classes-and-protocols"><a href="#Composing-classes-and-protocols" class="headerlink" title="Composing classes and protocols"></a>Composing classes and protocols</h2><p>SE-0156: You can now write the equivalent of the <code>Objective-C</code> code <code>UIViewController &lt;SomeProtocol&gt; *</code> in Swift, i.e. declare a variable of a concrete type and constrain it to one or more protocols at the same time. The syntax is <code>let variable: SomeClass &amp; SomeProtocol1 &amp; SomeProtocol2</code>.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> UIKit</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">HeaderView</span> </span>&#123;&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ViewController</span>: <span class="title">UIViewController</span> </span>&#123;</div><div class="line">    <span class="keyword">let</span> header: <span class="type">UIView</span> &amp; <span class="type">HeaderView</span></div><div class="line"></div><div class="line">    <span class="keyword">init</span>(header: <span class="type">UIView</span> &amp; <span class="type">HeaderView</span>) &#123;</div><div class="line">        <span class="keyword">self</span>.header = header</div><div class="line">        <span class="keyword">super</span>.<span class="keyword">init</span>(nibName: <span class="literal">nil</span>, bundle: <span class="literal">nil</span>)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">required</span> <span class="keyword">init</span>(coder decoder: <span class="type">NSCoder</span>) &#123;</div><div class="line">        <span class="built_in">fatalError</span>(<span class="string">"not implemented"</span>)</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Can't pass in a simple UIView that doesn't conform to the protocol</span></div><div class="line"><span class="comment">//ViewController(header: UIView())</span></div><div class="line"><span class="comment">// error: argument type 'UIView' does not conform to expected type 'UIView &amp; HeaderView'</span></div><div class="line"></div><div class="line"><span class="comment">// Must pass in an NSView (subclass) that also conforms to the protocol</span></div><div class="line"><span class="class"><span class="keyword">extension</span> <span class="title">UIImageView</span>: <span class="title">HeaderView</span> </span>&#123;&#125;</div><div class="line"></div><div class="line"><span class="type">ViewController</span>(header: <span class="type">UIImageView</span>()) <span class="comment">// works</span></div></pre></td></tr></table></figure>
<h4 id="Source"><a href="#Source" class="headerlink" title="Source:"></a>Source:</h4><ul>
<li><a href="https://www.appcoda.com/swift4-changes/" target="_blank" rel="external">https://www.appcoda.com/swift4-changes/</a></li>
<li><a href="https://github.com/ole/whats-new-in-swift-4" target="_blank" rel="external">https://github.com/ole/whats-new-in-swift-4</a></li>
</ul>
</div></article></div></main><footer><div class="paginator"></div><div class="copyright"><p>Make with love in Danang, VNM by <a href="https://duc.ninja">Duc</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-69523955-1",'auto');ga('send','pageview');</script></body></html>